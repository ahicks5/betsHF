{% extends "base.html" %}

{% block title %}Analytics Dashboard - TakeFreePoints.com{% endblock %}

{% block content %}
<!-- Page Header with Model Branding -->
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
    <h2 style="margin: 0;">Analytics Dashboard</h2>
    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.9rem; background: rgba(0, 255, 136, 0.08); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 6px;">
        <span style="width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 8px var(--accent-green);"></span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--accent-green);">Pulsar 1.0</span>
    </div>
</div>

<!-- KEY METRICS -->
<div class="stat-grid">
    <div class="stat-box">
        <h3>{{ total_plays }}</h3>
        <p>Total Plays</p>
        <small>{{ high_confidence }} High / {{ medium_confidence }} Medium</small>
    </div>
    <div class="stat-box">
        <h3>{{ total_graded }}</h3>
        <p>Graded Plays</p>
        <small>{{ wins }}W - {{ losses }}L</small>
    </div>
    <div class="stat-box">
        <h3>{{ win_rate|format_float(1) }}%</h3>
        <p>Win Rate</p>
        <small>{% if win_rate >= 55 %}üî• Excellent{% elif win_rate >= 50 %}‚úÖ Profitable{% else %}‚ö†Ô∏è Below 50%{% endif %}</small>
    </div>
    <div class="stat-box" style="{% if total_profit > 0 %}border-top: 3px solid var(--success);{% else %}border-top: 3px solid var(--danger);{% endif %}">
        <h3>${{ total_profit|format_float(2) }}</h3>
        <p>Total Profit</p>
        <small>{% if total_profit > 0 %}+{% endif %}{{ roi|format_float(1) }}% ROI</small>
    </div>
</div>

{% if total_graded > 0 %}

<!-- WINNING FORMULA -->
<div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), rgba(0, 136, 255, 0.05)); border: 1px solid rgba(0, 255, 136, 0.2);">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
        <span style="font-size: 1.5rem;">üéØ</span>
        <div>
            <h3 style="margin: 0;">Winning Formula</h3>
            <p style="margin: 0.25rem 0 0 0; color: var(--text-dim); font-size: 0.85rem;">Most profitable patterns in our model</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
        {% if winning_formula.direction.has_data %}
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Direction</div>
            <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: {% if winning_formula.direction.value == 'OVER' %}var(--success){% else %}var(--accent-blue){% endif %};">
                {{ winning_formula.direction.value }}
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                <span style="color: var(--success);">+${{ winning_formula.direction.profit|format_float(2) }}</span>
                <span style="color: var(--text-dim);">|</span>
                {{ winning_formula.direction.win_rate|format_float(0) }}%
            </div>
        </div>
        {% endif %}

        {% if winning_formula.confidence.has_data %}
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Confidence</div>
            <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: {% if winning_formula.confidence.value == 'High' %}var(--danger){% else %}var(--warning){% endif %};">
                {{ winning_formula.confidence.value }}
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                <span style="color: var(--success);">+${{ winning_formula.confidence.profit|format_float(2) }}</span>
                <span style="color: var(--text-dim);">|</span>
                {{ winning_formula.confidence.win_rate|format_float(0) }}%
            </div>
        </div>
        {% endif %}

        {% if winning_formula.stat.has_data %}
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Stat Type</div>
            <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: var(--accent-green);">
                {{ winning_formula.stat.value }}
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                <span style="color: var(--success);">+${{ winning_formula.stat.profit|format_float(2) }}</span>
                <span style="color: var(--text-dim);">|</span>
                {{ winning_formula.stat.win_rate|format_float(0) }}%
            </div>
        </div>
        {% endif %}

        {% if winning_formula.z_range.has_data %}
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Signal Strength</div>
            <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: var(--accent-purple);">
                {{ winning_formula.z_range.value }}œÉ
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                <span style="color: var(--success);">+${{ winning_formula.z_range.profit|format_float(2) }}</span>
                <span style="color: var(--text-dim);">|</span>
                {{ winning_formula.z_range.win_rate|format_float(0) }}%
            </div>
        </div>
        {% endif %}

        {% if winning_formula.bookmaker.has_data %}
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Bookmaker</div>
            <div style="font-size: 1.1rem; font-weight: 700; margin: 0.5rem 0; color: var(--text-primary);">
                {{ winning_formula.bookmaker.value|title|replace('_', ' ') }}
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                <span style="color: var(--success);">+${{ winning_formula.bookmaker.profit|format_float(2) }}</span>
                <span style="color: var(--text-dim);">|</span>
                {{ winning_formula.bookmaker.win_rate|format_float(0) }}%
            </div>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <p style="margin: 0; font-size: 0.85rem; color: var(--text-dim);">
            <strong style="color: var(--accent-green);">Optimal Play:</strong>
            {% if winning_formula.confidence.has_data and winning_formula.stat.has_data and winning_formula.direction.has_data %}
            {{ winning_formula.confidence.value }} confidence {{ winning_formula.direction.value }} bets on {{ winning_formula.stat.value }}
            {% if winning_formula.z_range.has_data %} with {{ winning_formula.z_range.value }}œÉ signals{% endif %}
            {% else %}
            Collecting more data to identify patterns...
            {% endif %}
        </p>
    </div>
</div>

<!-- ODDS ANALYSIS -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Odds Analysis</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
    <div class="card">
        <h3 style="color: var(--success);">Winning Bets</h3>
        <div style="text-align: center; padding: 1.5rem 0;">
            <h2 style="color: var(--success); margin: 0;">{% if avg_winning_odds > 0 %}+{% endif %}{{ avg_winning_odds|round(1) }}</h2>
            <p style="margin-top: 0.5rem; color: var(--text-dim);">Average Odds</p>
        </div>
    </div>
    <div class="card">
        <h3 style="color: var(--danger);">Losing Bets</h3>
        <div style="text-align: center; padding: 1.5rem 0;">
            <h2 style="color: var(--danger); margin: 0;">{% if avg_losing_odds > 0 %}+{% endif %}{{ avg_losing_odds|round(1) }}</h2>
            <p style="margin-top: 0.5rem; color: var(--text-dim);">Average Odds</p>
        </div>
    </div>
</div>

<!-- OVER VS UNDER PERFORMANCE -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Over vs Under Performance</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
    <div class="card" style="border-left: 4px solid var(--success);">
        <h3>OVER Bets</h3>
        <div style="margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Win Rate:</span>
                <strong style="color: {% if over_win_rate >= 50 %}var(--success){% else %}var(--danger){% endif %};">{{ over_win_rate|format_float(1) }}%</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Record:</span>
                <strong>{{ (over_total * over_win_rate / 100)|int }}-{{ over_total - (over_total * over_win_rate / 100)|int }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Profit:</span>
                <strong style="color: {% if over_profit > 0 %}var(--success){% else %}var(--danger){% endif %};">${{ over_profit|format_float(2) }}</strong>
            </div>
        </div>
    </div>

    <div class="card" style="border-left: 4px solid var(--accent-blue);">
        <h3>UNDER Bets</h3>
        <div style="margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Win Rate:</span>
                <strong style="color: {% if under_win_rate >= 50 %}var(--success){% else %}var(--danger){% endif %};">{{ under_win_rate|format_float(1) }}%</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Record:</span>
                <strong>{{ (under_total * under_win_rate / 100)|int }}-{{ under_total - (under_total * under_win_rate / 100)|int }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Profit:</span>
                <strong style="color: {% if under_profit > 0 %}var(--success){% else %}var(--danger){% endif %};">${{ under_profit|format_float(2) }}</strong>
            </div>
        </div>
    </div>
</div>

<!-- PERFORMANCE BREAKDOWNS -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Performance Breakdowns</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
    <div class="card">
        <h3>By Confidence Level</h3>
        <table style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Level</th>
                    <th>Record</th>
                    <th>Win Rate</th>
                    <th>Profit</th>
                    <th>ROI</th>
                </tr>
            </thead>
            <tbody>
                {% for conf in ['High', 'Medium'] %}
                <tr>
                    <td><strong>{{ conf }}</strong></td>
                    <td>{{ win_rate_by_conf[conf].wins }}-{{ win_rate_by_conf[conf].total - win_rate_by_conf[conf].wins }}</td>
                    <td><strong style="color: {% if win_rate_by_conf[conf].rate >= 50 %}var(--success){% else %}var(--danger){% endif %};">{{ win_rate_by_conf[conf].rate|format_float(1) }}%</strong></td>
                    <td style="color: {% if profit_by_conf[conf] > 0 %}var(--success){% else %}var(--danger){% endif %};">
                        ${{ profit_by_conf[conf]|format_float(2) }}
                    </td>
                    <td>{{ ((profit_by_conf[conf] / (win_rate_by_conf[conf].total * bet_amount)) * 100)|format_float(1) if win_rate_by_conf[conf].total > 0 else 0 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h3>By Stat Type</h3>
        <table style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Stat</th>
                    <th>Record</th>
                    <th>Win Rate</th>
                    <th>Profit</th>
                </tr>
            </thead>
            <tbody>
                {% for stat, data in win_rate_by_stat.items()|sort(attribute='1.rate', reverse=True) %}
                <tr>
                    <td><strong>{{ stat }}</strong></td>
                    <td>{{ data.wins }}-{{ data.total - data.wins }}</td>
                    <td><strong style="color: {% if data.rate >= 50 %}var(--success){% else %}var(--danger){% endif %};">{{ data.rate|format_float(1) }}%</strong></td>
                    <td style="color: {% if profit_by_stat[stat] > 0 %}var(--success){% else %}var(--danger){% endif %};">
                        ${{ profit_by_stat[stat]|format_float(2) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Z-SCORE EFFECTIVENESS -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Signal Strength Performance</h2>
<div class="card">
    <h3>Profitability by Z-Score Range</h3>
    <p style="margin-top: 0.5rem; color: var(--text-dim);">Does higher confidence signal translate to better profits?</p>
    <table style="margin-top: 1.5rem;">
        <thead>
            <tr>
                <th>Signal Strength</th>
                <th>Plays</th>
                <th>Record</th>
                <th>Win %</th>
                <th>Profit</th>
                <th>ROI</th>
                <th>Performance</th>
            </tr>
        </thead>
        <tbody>
            {% for range in ['1.5+', '1.0-1.5', '0.75-1.0', '0.5-0.75'] %}
            {% set range_profit = profit_by_z_score_range.get(range, 0) if profit_by_z_score_range else 0 %}
            {% set range_roi = ((range_profit / (z_score_performance[range].total * bet_amount)) * 100) if z_score_performance[range].total > 0 else 0 %}
            <tr>
                <td>
                    <strong>{{ range }}œÉ</strong>
                    {% if range == '1.5+' %}
                        <br><small style="color: var(--text-dim);">Strongest</small>
                    {% elif range == '0.5-0.75' %}
                        <br><small style="color: var(--text-dim);">Weakest</small>
                    {% endif %}
                </td>
                <td>{{ z_score_performance[range].total }}</td>
                <td>{{ z_score_performance[range].wins }}-{{ z_score_performance[range].total - z_score_performance[range].wins }}</td>
                <td><strong>{{ z_score_performance[range].win_rate|format_float(1) }}%</strong></td>
                <td style="font-weight: 700; font-family: 'JetBrains Mono', monospace; {% if range_profit > 0 %}color: var(--success);{% elif range_profit < 0 %}color: var(--danger);{% endif %}">
                    {% if range_profit > 0 %}+{% endif %}${{ range_profit|format_float(2) }}
                </td>
                <td style="{% if range_roi > 0 %}color: var(--success);{% elif range_roi < 0 %}color: var(--danger);{% endif %}">
                    {{ range_roi|format_float(1) }}%
                </td>
                <td>
                    {% if range_profit > 20 %}
                        <span class="badge" style="background: linear-gradient(135deg, var(--success), #059669); color: white;">üí∞ Profitable</span>
                    {% elif range_profit > 0 %}
                        <span class="badge" style="background: var(--success); color: white;">‚úì Positive</span>
                    {% elif range_profit == 0 %}
                        <span class="badge" style="background: var(--text-dim); color: white;">‚Üí Break Even</span>
                    {% else %}
                        <span class="badge" style="background: var(--text-secondary); color: white;">‚Üì Negative</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-dim);">
        <strong>Note:</strong> Profitability matters more than win rate. A 48% win rate with favorable odds can be more profitable than a 52% win rate with poor odds.
    </p>
</div>

<!-- TOP & WORST PLAYERS -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Player Performance</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem;">
    <div class="card" style="border-top: 3px solid var(--success);">
        <h3>üèÜ Top 10 Most Profitable Players</h3>
        <table style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Record</th>
                    <th>Win %</th>
                    <th>Profit</th>
                </tr>
            </thead>
            <tbody>
                {% for player_name, stats in top_players %}
                <tr>
                    <td><strong>{{ player_name[:20] }}</strong></td>
                    <td>{{ stats.wins }}-{{ stats.total - stats.wins }}</td>
                    <td>{{ stats.win_rate|format_float(1) }}%</td>
                    <td style="color: var(--success); font-weight: bold;">${{ stats.profit|format_float(2) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card" style="border-top: 3px solid var(--danger);">
        <h3>üí∏ Worst 10 Players (By Profit)</h3>
        <table style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Record</th>
                    <th>Win %</th>
                    <th>Loss</th>
                </tr>
            </thead>
            <tbody>
                {% for player_name, stats in worst_players %}
                <tr>
                    <td><strong>{{ player_name[:20] }}</strong></td>
                    <td>{{ stats.wins }}-{{ stats.total - stats.wins }}</td>
                    <td>{{ stats.win_rate|format_float(1) }}%</td>
                    <td style="color: var(--danger); font-weight: bold;">${{ stats.profit|format_float(2) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- BOOKMAKER ANALYSIS -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Bookmaker Analysis</h2>
<div class="card">
    <h3>Performance by Sportsbook</h3>
    <p style="margin-top: 0.5rem; color: var(--text-dim);">Which bookmakers provide the best value?</p>
    <table style="margin-top: 1.5rem;">
        <thead>
            <tr>
                <th>Bookmaker</th>
                <th>Plays</th>
                <th>Record</th>
                <th>Win Rate</th>
                <th>Profit</th>
                <th>ROI</th>
            </tr>
        </thead>
        <tbody>
            {% for bookie, stats in bookmaker_stats.items()|sort(attribute='1.profit', reverse=True) %}
            <tr>
                <td><strong>{{ bookie }}</strong></td>
                <td>{{ stats.total }}</td>
                <td>{{ stats.wins }}-{{ stats.total - stats.wins }}</td>
                <td><strong style="color: {% if stats.win_rate >= 50 %}var(--success){% else %}var(--danger){% endif %};">{{ stats.win_rate|format_float(1) }}%</strong></td>
                <td style="color: {% if stats.profit > 0 %}var(--success){% else %}var(--danger){% endif %}; font-weight: bold;">${{ stats.profit|format_float(2) }}</td>
                <td>{{ ((stats.profit / (stats.total * bet_amount)) * 100)|format_float(1) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- PROFIT OVER TIME -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Profit Over Time</h2>
<div class="card">
    <h3>Cumulative Profit Trend</h3>
    <p style="margin-top: 0.5rem; color: var(--text-dim);">Track how your bankroll has grown over time</p>

    <!-- Chart -->
    <div style="margin-top: 1.5rem; height: 300px; position: relative;">
        <canvas id="profitChart"></canvas>
    </div>

    <!-- Summary Stats Row -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
        <div style="text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Unit Size</div>
            <div style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">$10</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Current P/L</div>
            <div style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: {% if total_profit > 0 %}var(--success){% else %}var(--danger){% endif %};">
                {% if total_profit > 0 %}+{% endif %}${{ total_profit|format_float(2) }}
            </div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Best Day</div>
            <div style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--success);">
                {% if daily_profit %}+${{ (daily_profit|map(attribute='1')|max)|format_float(2) }}{% else %}$0.00{% endif %}
            </div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Days Tracked</div>
            <div style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">{{ days_tracked }}</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Profit Over Time Chart - Aggregate by date, start from $0
const rawProfitData = {{ cumulative_profit_data|tojson }};

// Aggregate to get one point per date (last value of each day)
const dateMap = new Map();
rawProfitData.forEach(d => {
    dateMap.set(d.date, d.profit);
});

// Build data starting from $0
let chartLabels = ['Start'];
let chartData = [0];

const sortedDates = Array.from(dateMap.entries())
    .sort((a, b) => new Date(a[0]) - new Date(b[0]));

sortedDates.forEach(([date, profit]) => {
    const dateObj = new Date(date);
    chartLabels.push(dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    chartData.push(profit);
});

const ctx = document.getElementById('profitChart').getContext('2d');
const finalProfit = chartData.length > 1 ? chartData[chartData.length - 1] : 0;
const lineColor = finalProfit >= 0 ? '#00ff88' : '#e74c3c';
const bgColor = finalProfit >= 0 ? 'rgba(0, 255, 136, 0.15)' : 'rgba(231, 76, 60, 0.15)';

new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartLabels,
        datasets: [{
            label: 'Cumulative Profit ($)',
            data: chartData,
            borderColor: lineColor,
            backgroundColor: bgColor,
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 8,
            pointBackgroundColor: lineColor,
            pointBorderColor: '#1a1a2e',
            pointBorderWidth: 2,
            pointHitRadius: 20,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
            mode: 'index'
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(30, 30, 30, 0.95)',
                titleColor: '#e0e0e0',
                bodyColor: '#e0e0e0',
                borderColor: lineColor,
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                    title: function(context) {
                        return context[0].label;
                    },
                    label: function(context) {
                        let value = context.parsed.y;
                        let prefix = value >= 0 ? '+' : '';
                        return 'Profit: ' + prefix + '$' + value.toFixed(2);
                    }
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#999',
                    maxRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: 8
                },
                grid: {
                    display: false
                }
            },
            y: {
                ticks: {
                    color: '#999',
                    callback: function(value) {
                        return (value >= 0 ? '+' : '') + '$' + value.toFixed(0);
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                },
                suggestedMin: Math.min(0, ...chartData) - 5,
                suggestedMax: Math.max(0, ...chartData) + 5
            }
        }
    }
});
</script>

<!-- DAILY PROFIT -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Recent Daily Performance</h2>
<div class="card">
    <h3>Last 30 Days - Profit/Loss by Date</h3>
    <table style="margin-top: 1.5rem;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Daily P/L</th>
                <th>Performance</th>
            </tr>
        </thead>
        <tbody>
            {% for date, profit in daily_profit[:15] %}
            <tr>
                <td>{{ date }}</td>
                <td style="color: {% if profit > 0 %}var(--success){% else %}var(--danger){% endif %}; font-weight: bold; font-family: 'JetBrains Mono', monospace;">
                    {% if profit > 0 %}+{% endif %}${{ profit|format_float(2) }}
                </td>
                <td>
                    {% if profit > 10 %}
                        <span class="badge badge-high">üî• Great Day</span>
                    {% elif profit > 0 %}
                        <span class="badge badge-over">Profitable</span>
                    {% elif profit == 0 %}
                        <span class="badge badge-no-play">Break Even</span>
                    {% else %}
                        <span class="badge" style="background: var(--danger);">Loss</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- GAME ANALYSIS -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Game Analysis</h2>
<div class="card">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
        <span style="font-size: 1.5rem;">üîç</span>
        <div>
            <h3 style="margin: 0;">Analyze by Game</h3>
            <p style="margin: 0.25rem 0 0 0; color: var(--text-dim); font-size: 0.85rem;">Select a date and matchup to see player prop performance</p>
        </div>
    </div>

    <!-- Game Selection -->
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
        <div>
            <label style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.4rem; display: block; text-transform: uppercase; letter-spacing: 0.05em;">Date</label>
            <input type="date" id="game-analysis-date" onchange="loadGamesForDate()" style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 0.85rem;">
        </div>
        <div style="min-width: 200px;">
            <label style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.4rem; display: block; text-transform: uppercase; letter-spacing: 0.05em;">Matchup</label>
            <select id="game-analysis-select" onchange="loadGameAnalysis()" style="padding: 0.6rem 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 0.85rem; min-width: 180px;" disabled>
                <option value="">Select a date first</option>
            </select>
        </div>
    </div>

    <!-- Analysis Results -->
    <div id="game-analysis-results" style="display: none;">
        <!-- Summary Cards -->
        <div id="game-analysis-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        </div>

        <!-- Player Results Table -->
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="game-analysis-table">
                <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 10;">
                    <tr>
                        <th>Player</th>
                        <th>Stat</th>
                        <th>Line</th>
                        <th>Play</th>
                        <th>Result</th>
                        <th>Outcome</th>
                        <th>P/L</th>
                    </tr>
                </thead>
                <tbody id="game-analysis-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Empty State -->
    <div id="game-analysis-empty" style="text-align: center; padding: 2rem; color: var(--text-dim);">
        <p>Select a date and game above to analyze player prop performance</p>
    </div>

    <!-- Loading State -->
    <div id="game-analysis-loading" style="display: none; text-align: center; padding: 2rem;">
        <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 1rem; color: var(--text-dim);">Loading analysis...</p>
    </div>
</div>

<script>
async function loadGamesForDate() {
    const dateInput = document.getElementById('game-analysis-date');
    const gameSelect = document.getElementById('game-analysis-select');
    const resultsDiv = document.getElementById('game-analysis-results');
    const emptyDiv = document.getElementById('game-analysis-empty');

    if (!dateInput.value) {
        gameSelect.innerHTML = '<option value="">Select a date first</option>';
        gameSelect.disabled = true;
        return;
    }

    gameSelect.innerHTML = '<option value="">Loading...</option>';
    gameSelect.disabled = true;
    resultsDiv.style.display = 'none';
    emptyDiv.style.display = 'block';

    try {
        const response = await fetch(`/api/games-by-date?date=${dateInput.value}`);
        const games = await response.json();

        if (games.length === 0) {
            gameSelect.innerHTML = '<option value="">No games on this date</option>';
            return;
        }

        gameSelect.innerHTML = '<option value="">Select a game...</option>';
        games.forEach(game => {
            const status = game.is_completed ? '‚úì' : '';
            gameSelect.innerHTML += `<option value="${game.id}">${game.matchup} ${game.game_date} ${status}</option>`;
        });
        gameSelect.disabled = false;
    } catch (error) {
        console.error('Error loading games:', error);
        gameSelect.innerHTML = '<option value="">Error loading games</option>';
    }
}

async function loadGameAnalysis() {
    const gameSelect = document.getElementById('game-analysis-select');
    const resultsDiv = document.getElementById('game-analysis-results');
    const emptyDiv = document.getElementById('game-analysis-empty');
    const loadingDiv = document.getElementById('game-analysis-loading');
    const summaryDiv = document.getElementById('game-analysis-summary');
    const tbody = document.getElementById('game-analysis-tbody');

    const gameId = gameSelect.value;
    if (!gameId) {
        resultsDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }

    emptyDiv.style.display = 'none';
    loadingDiv.style.display = 'block';
    resultsDiv.style.display = 'none';

    try {
        const response = await fetch(`/api/game-analysis/${gameId}`);
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Build summary cards
        const s = data.summary;
        const overWinRate = s.over_count > 0 ? ((s.over_wins / (s.over_wins + s.over_losses)) * 100).toFixed(0) : 0;
        const underWinRate = s.under_count > 0 ? ((s.under_wins / (s.under_wins + s.under_losses)) * 100).toFixed(0) : 0;

        summaryDiv.innerHTML = `
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">Total Plays</div>
                <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0;">${s.total_plays}</div>
            </div>
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center; border-top: 3px solid var(--success);">
                <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">Overs</div>
                <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: var(--success);">${s.over_wins}-${s.over_losses}</div>
                <div style="font-size: 0.8rem; color: ${s.over_profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                    ${s.over_profit >= 0 ? '+' : ''}$${s.over_profit.toFixed(2)}
                </div>
            </div>
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center; border-top: 3px solid var(--accent-blue);">
                <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">Unders</div>
                <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: var(--accent-blue);">${s.under_wins}-${s.under_losses}</div>
                <div style="font-size: 0.8rem; color: ${s.under_profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                    ${s.under_profit >= 0 ? '+' : ''}$${s.under_profit.toFixed(2)}
                </div>
            </div>
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center; border-top: 3px solid ${s.total_profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                <div style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">Game P/L</div>
                <div style="font-size: 1.4rem; font-weight: 700; margin: 0.5rem 0; color: ${s.total_profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                    ${s.total_profit >= 0 ? '+' : ''}$${s.total_profit.toFixed(2)}
                </div>
            </div>
        `;

        // Build player table
        tbody.innerHTML = '';
        data.players.forEach(p => {
            const badgeClass = p.recommendation === 'OVER' ? 'badge-over' : 'badge-under';
            let outcomeHtml = '<span style="color: var(--text-dim);">-</span>';
            if (p.was_correct === true) {
                outcomeHtml = '<span class="badge" style="background: var(--success); color: white;">WIN</span>';
            } else if (p.was_correct === false) {
                outcomeHtml = '<span class="badge" style="background: var(--danger); color: white;">LOSS</span>';
            }

            let profitHtml = '<span style="color: var(--text-dim);">-</span>';
            if (p.was_correct !== null) {
                const color = p.profit >= 0 ? 'var(--success)' : 'var(--danger)';
                profitHtml = `<span style="color: ${color}; font-weight: bold; font-family: 'JetBrains Mono', monospace;">${p.profit >= 0 ? '+' : ''}$${p.profit.toFixed(2)}</span>`;
            }

            tbody.innerHTML += `
                <tr>
                    <td><strong>${p.player_name}</strong></td>
                    <td>${p.stat_type}</td>
                    <td>${p.line_value.toFixed(1)}</td>
                    <td><span class="badge ${badgeClass}">${p.recommendation}</span></td>
                    <td>${p.actual_result !== null ? Math.round(p.actual_result) : '-'}</td>
                    <td>${outcomeHtml}</td>
                    <td>${profitHtml}</td>
                </tr>
            `;
        });

        loadingDiv.style.display = 'none';
        resultsDiv.style.display = 'block';
    } catch (error) {
        console.error('Error loading analysis:', error);
        loadingDiv.style.display = 'none';
        emptyDiv.innerHTML = `<p style="color: var(--danger);">Error loading analysis: ${error.message}</p>`;
        emptyDiv.style.display = 'block';
    }
}

// Set default date to yesterday
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('game-analysis-date');
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    dateInput.value = yesterday.toISOString().split('T')[0];
    loadGamesForDate();
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

{% else %}
<div class="card" style="margin-top: 2rem; text-align: center; padding: 3rem 1.5rem;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
    <h3 style="margin-bottom: 0.5rem;">Analytics Coming Soon</h3>
    <p style="color: var(--text-secondary); max-width: 400px; margin: 0 auto;">
        Once games are completed and results are collected, comprehensive analytics will appear here.
    </p>
</div>
{% endif %}

<!-- RISK METRICS (Hedge Fund Style) -->
<h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Risk & Performance Metrics</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-box" style="border-left: 3px solid var(--accent-purple);">
        <p style="color: var(--text-dim); font-size: 0.75rem;">CURRENT STREAK</p>
        <h3 style="font-size: 2rem; margin: 0.5rem 0;">
            {% if current_streak > 0 %}
                {{ current_streak }}W
            {% elif current_streak < 0 %}
                {{ current_streak|abs }}L
            {% else %}
                -
            {% endif %}
        </h3>
        <small style="color: {% if current_streak > 0 %}var(--success){% elif current_streak < 0 %}var(--danger){% else %}var(--text-dim){% endif %};">
            {% if current_streak > 0 %}üî• On Fire{% elif current_streak < 0 %}üìâ Cold Streak{% else %}Fresh Start{% endif %}
        </small>
    </div>

    <div class="stat-box" style="border-left: 3px solid var(--success);">
        <p style="color: var(--text-dim); font-size: 0.75rem;">LONGEST WIN STREAK</p>
        <h3 style="font-size: 2rem; margin: 0.5rem 0; color: var(--success);">{{ longest_win_streak }}</h3>
        <small style="color: var(--text-dim);">consecutive wins</small>
    </div>

    <div class="stat-box" style="border-left: 3px solid var(--danger);">
        <p style="color: var(--text-dim); font-size: 0.75rem;">MAX DRAWDOWN</p>
        <h3 style="font-size: 2rem; margin: 0.5rem 0; color: var(--danger);">
            {% if max_drawdown %}
                ${{ max_drawdown|format_float(2) }}
            {% else %}
                $0.00
            {% endif %}
        </h3>
        <small style="color: var(--text-dim);">biggest bankroll dip</small>
    </div>

    <div class="stat-box" style="border-left: 3px solid var(--warning);">
        <p style="color: var(--text-dim); font-size: 0.75rem;">AVG WIN vs AVG LOSS</p>
        <h3 style="font-size: 1.5rem; margin: 0.5rem 0;">
            <span style="color: var(--success);">${{ avg_win_amount|format_float(2) }}</span>
            <span style="color: var(--text-dim);"> / </span>
            <span style="color: var(--danger);">${{ avg_loss_amount|format_float(2) }}</span>
        </h3>
        <small style="color: var(--text-dim);">per bet (units)</small>
    </div>
</div>

<div class="card">
    <h3>Performance Profile</h3>
    <p style="color: var(--text-dim); margin-top: 0.5rem;">Key metrics for evaluating betting performance</p>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
        <div>
            <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">WIN/LOSS RATIO</div>
            <div style="font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">
                {% if avg_loss_amount != 0 and avg_win_amount and avg_loss_amount %}
                    {{ (avg_win_amount / avg_loss_amount)|format_float(2) }}:1
                {% else %}
                    -
                {% endif %}
            </div>
            <small style="color: var(--text-dim);">
                {% set ratio = (avg_win_amount / avg_loss_amount) if avg_loss_amount != 0 and avg_win_amount and avg_loss_amount else 0 %}
                {% if ratio > 2 %}Excellent{% elif ratio > 1.5 %}Good{% elif ratio > 1 %}Solid{% else %}Building{% endif %}
            </small>
        </div>

        <div>
            <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">PROFIT FACTOR</div>
            <div style="font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">
                {% if total_losses != 0 and total_winnings and total_losses %}
                    {{ (total_winnings / total_losses)|format_float(2) }}
                {% else %}
                    -
                {% endif %}
            </div>
            <small style="color: var(--text-dim);">gross wins / gross losses</small>
        </div>

        <div>
            <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">CONSISTENCY</div>
            <div style="font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">
                {{ ((wins / total_graded * 100) if total_graded > 0 else 0)|format_float(0) }}%
            </div>
            <small style="color: var(--text-dim);">based on win rate</small>
        </div>

        <div>
            <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">RECOVERY STRENGTH</div>
            <div style="font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">
                {% if max_drawdown and total_profit %}
                    {% if total_profit > 0 %}
                        <span style="color: var(--success);">Strong</span>
                    {% else %}
                        <span style="color: var(--warning);">Building</span>
                    {% endif %}
                {% else %}
                    -
                {% endif %}
            </div>
            <small style="color: var(--text-dim);">profit vs drawdown</small>
        </div>
    </div>
</div>

<!-- ABOUT SECTION -->
<div class="card" style="margin-top: 2.5rem;">
    <h3>About This Dashboard</h3>
    <p style="margin-bottom: 1rem;">Hedge fund-style analytics tracking betting performance across multiple dimensions.</p>
    <ul style="margin-left: 2rem; line-height: 2;">
        <li><strong>ROI:</strong> Return on investment - total profit as % of total amount wagered</li>
        <li><strong>Max Drawdown:</strong> Largest peak-to-trough decline in bankroll</li>
        <li><strong>Win/Loss Ratio:</strong> Average winning bet amount vs average losing bet amount</li>
        <li><strong>Profit Factor:</strong> Gross profits divided by gross losses (>1 = profitable)</li>
        <li><strong>Z-Score:</strong> Statistical measure of how far the Vegas line deviates from expected value</li>
    </ul>
</div>

<style>
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        /* Stack grids on mobile */
        .stat-grid,
        div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }

        /* Make tables scrollable on mobile */
        table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        /* Smaller font sizes on mobile */
        h1 {
            font-size: 1.8rem !important;
        }

        h2 {
            font-size: 1.5rem !important;
        }

        h3 {
            font-size: 1.2rem !important;
        }

        /* Reduce padding in stat boxes */
        .stat-box {
            padding: 1rem !important;
        }

        .stat-box h3 {
            font-size: 1.8rem !important;
        }

        /* Make cards more compact */
        .card {
            padding: 1rem !important;
        }

        /* Stack page header on mobile */
        div[style*="display: flex; align-items: center"] {
            flex-wrap: wrap;
        }

        /* Reduce chart height on mobile */
        #profitChart {
            height: 200px !important;
        }

        div[style*="height: 300px"] {
            height: 200px !important;
        }
    }

    /* Very small screens */
    @media (max-width: 480px) {
        /* Even smaller fonts */
        body {
            font-size: 14px;
        }

        /* Compact stat boxes */
        .stat-box h3 {
            font-size: 1.5rem !important;
        }

        .stat-box p {
            font-size: 0.7rem !important;
        }

        /* Hide some columns in tables on very small screens */
        table th:nth-child(n+5),
        table td:nth-child(n+5) {
            display: none;
        }
    }
</style>

{% endblock %}
