{% extends "base.html" %}

{% block title %}Play History - PropEdge{% endblock %}

{% block content %}
<!-- Page Header with Model Branding -->
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
    <h2 style="margin: 0;">Play History</h2>
    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.9rem; background: rgba(0, 255, 136, 0.08); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 6px;">
        <span style="width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 8px var(--accent-green);"></span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--accent-green);">Pulsar 1.0</span>
    </div>
</div>

<div class="filters">
    <form method="get">
        <div>
            <label>Show last:</label>
            <select name="days" onchange="this.form.submit()">
                <option value="7" {% if days == 7 %}selected{% endif %}>7 days</option>
                <option value="14" {% if days == 14 %}selected{% endif %}>14 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>30 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>90 days</option>
            </select>
        </div>
        <button type="submit">Update</button>
    </form>
</div>

{% if plays_by_date %}
    {% for date, plays in plays_by_date.items()|sort(reverse=True) %}
    <div class="card">
        <h3>{{ date.strftime('%B %d, %Y') }} - {{ plays|length }} plays</h3>

        <table>
            <thead>
                <tr>
                    <th>Matchup</th>
                    <th>Game Date</th>
                    <th>Player</th>
                    <th>Stat</th>
                    <th>Vegas Line</th>
                    <th>Play</th>
                    <th>Odds</th>
                    <th>Strength</th>
                    <th>Actual Result</th>
                    <th>Outcome</th>
                    <th>Profit/Loss</th>
                </tr>
            </thead>
            <tbody>
                {% for play, game, matchup in plays %}
                {% set game_local = game.game_date|to_local %}
                <tr>
                    <td style="white-space: nowrap; font-weight: 600;">{{ matchup }}</td>
                    <td style="white-space: nowrap;">{{ game_local.strftime('%b %d, %I:%M %p') }}</td>
                    <td><a href="/plays/{{ play.id }}" class="play-link">{{ play.player_name }}</a></td>
                    <td>{{ play.stat_type }}</td>
                    <td><strong>{{ play.line_value|format_line }}</strong></td>
                    <td>
                        {% if play.recommendation == 'OVER' %}
                            <span class="badge badge-over">OVER</span>
                        {% elif play.recommendation == 'UNDER' %}
                            <span class="badge badge-under">UNDER</span>
                        {% else %}
                            <span class="badge badge-no-play">NO PLAY</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if play.recommendation == 'OVER' %}
                            {{ play.over_odds|format_odds }}
                        {% elif play.recommendation == 'UNDER' %}
                            {{ play.under_odds|format_odds }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; align-items: baseline; gap: 0.5rem; font-family: 'JetBrains Mono', monospace;">
                            <span style="font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 3px; font-weight: 700; {% if play.confidence == 'High' %}background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3);{% else %}background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3);{% endif %}">{{ play.confidence[0] }}</span>
                            <span style="color: var(--text-secondary);">{{ play.z_score|z_to_confidence }}</span>
                        </div>
                    </td>
                    <td>
                        {% if play.actual_result is not none %}
                            <strong>{{ play.actual_result|int }}</strong>
                        {% else %}
                            <span style="color: #95a5a6;">Pending</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if play.recommendation == 'NO PLAY' %}
                            {% if play.actual_result is not none %}
                                <span class="badge" style="background: #95a5a6; color: white;">SKIP</span>
                            {% else %}
                                <span style="color: #95a5a6;">-</span>
                            {% endif %}
                        {% elif play.was_correct == true %}
                            <span class="badge" style="background: #27ae60; color: white;">✓ WIN</span>
                        {% elif play.was_correct == false %}
                            <span class="badge" style="background: #e74c3c; color: white;">✗ LOSS</span>
                        {% else %}
                            <span style="color: #95a5a6;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if play.recommendation != 'NO PLAY' and play.was_correct is not none %}
                            {{ play|calculate_profit(10)|safe }}
                        {% else %}
                            <span style="color: #95a5a6;">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
{% else %}
<div class="empty-state">
    <h2>No historical plays found</h2>
    <p>Start running the daily analysis to build up historical data.</p>
</div>
{% endif %}
{% endblock %}
